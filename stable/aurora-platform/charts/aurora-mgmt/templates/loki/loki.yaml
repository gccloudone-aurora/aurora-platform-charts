{{ if .Values.components.loki.enabled -}}

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: "{{ .Values.global.cluster }}-loki"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: {{ .Values.global.project }}
  source:
    chart: {{ default "loki" .Values.components.loki.helm.chart }}
    {{- if .Values.components.loki.helm.repository }}
    repoURL: {{ .Values.components.loki.helm.repository }}
    {{- else }}
    repoURL: {{ default "https://grafana.github.io/helm-charts" .Values.global.helm.repository }}
    {{- end }}
    targetRevision: {{ default "6.21.0" .Values.components.loki.helm.targetRevision }}
    plugin:
      env:
        - name: HELM_RELEASE_NAME
          value: "loki"
        - name: HELM_VALUES
          value: |
            global:
              image:
                registry: null

            # Need both of these: 
            # https://github.com/grafana/loki/issues/12632#issuecomment-2063170281
            image:
              pullSecrets:
              - aurora-image-pull-secret
            imagePullSecrets:
              - name: aurora-image-pull-secret
            deploymentMode: SimpleScalable

            gateway:
              nodeSelector: {{ toYaml .Values.components.loki.nodeSelector | nindent 16 }}
              tolerations: {{ toYaml .Values.components.loki.tolerations | nindent 16 }}

              ingress:
                enabled: true
                hosts:
                  - host: loki.{{ .Values.global.ingressDomain }}
                    paths:
                      - path: /.*
                        pathType: ImplementationSpecific
                tls:
                  - secretName: loki-gateway-tls
                    hosts:
                      - loki.{{ .Values.global.ingressDomain }}
              basicAuth:
                enabled: true
                username: {{ required "loki.basicAuth.username is required" .Values.components.loki.basicAuth.username | quote }}
                password: {{ required "loki.basicAuth.password is required" .Values.components.loki.basicAuth.password | quote }}

            loki:
              image: {{ default "{}" (include "loki.image" .) | nindent 16ÃŸ }}
              analytics:
                reporting_enabled: false
              # Authentication for multitenancy, which we are not presently using.
              auth_enabled: false
              compactor:
                working_directory: /var/loki/data/retention
                compaction_interval: 10m
                retention_enabled: true
                retention_delete_delay: 10m # 2h in docs, putting a smaller value to test
                retention_delete_worker_count: 150
                delete_request_store: azure
              limits_config:
                ingestion_rate_mb: 10
                ingestion_burst_size_mb: 20
                reject_old_samples_max_age: 24h
                retention_period: 2160h # 90d
                retention_stream:
                - selector: '{source="kubernetes-event-exporter"}'
                  priority: 1
                  period: 336h # 14d
              schemaConfig:
                configs:
                  - from: 2024-05-01
                    object_store: azure
                    store: tsdb
                    schema: v13
                    index:
                      prefix: loki_
                      period: 24h
              storage:
                type: azure
                # admin and ruler are not presently in use. Pointing them to the same chunks bucket for now.
                # Separate them out later if they will have contents that we do not want cleaned up by storage account retention policies.
                # See https://github.com/grafana/loki/issues/8524
                bucketNames:
                  admin: chunks
                  chunks: chunks
                  ruler: chunks
              azure: {{ include "loki.logStorageLocation" . | nindent  16 }}

            # Disable lokiCanary, which can only be deployed as a DaemonSet
            lokiCanary:
              enabled: false
            test:
              enabled: false
            # Does not inherit global image registry
            memcached:
              image:
                repository: docker.io/memcached
            # Does not inherit global image registry
            memcachedExporter:
              image:
                repository: docker.io/prom/memcached-exporter
            # Does not inherit global image registry
            sidecar:
              image:
                repository: docker.io/kiwigrid/k8s-sidecar
              # Disable rules until we plan to configure rules and the ruler
              rules:
                enabled: false
            # Istio compatibility: 
            # https://grafana.com/docs/loki/latest/operations/troubleshooting/#running-loki-with-istio-sidecars
            ingester:
              appProtocol:
                grpc: tcp
            distributor:
              appProtocol:
                grpc: tcp
            querier:
              appProtocol:
                grpc: tcp
            queryFrontend:
              appProtocol:
                grpc: tcp
            queryScheduler:
              appProtocol:
                grpc: tcp
            # Prevent the creation of a cluster role to check other namespaces for 
            # configmaps/secrets, which we do not require
            rbac:
              namespaced: true
            write:
              persistence:
                size: 8Gi
                storageClass: default
            read:
              persistence:
                size: 8Gi
                storageClass: default
            backend:
              persistence:
                size: 8Gi
                storageClass: default
  destination:
    name: '{{ .Values.global.cluster }}'
    namespace: loki-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true

{{- end }}
