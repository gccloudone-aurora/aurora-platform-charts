{{ if .Values.components.argocdSolutions.enabled -}}

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: "{{ .Values.global.cluster }}-solution-argocd-instance"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: {{ .Values.global.project }}
  source:
    chart: {{ default "argocd-instance" .Values.components.argocdSolutions.argocdInstance.helm.chart }}
    {{- if .Values.components.argocdSolutions.argocdInstance.helm.repository }}
    repoURL: {{ .Values.components.argocdSolutions.argocdInstance.helm.repository }}
    {{- else }}
    repoURL: {{ default "https://gccloudone-aurora.github.io/aurora-platform-charts" .Values.global.helm.repository }}
    {{- end }}
    targetRevision: {{ default "0.4.0" .Values.components.argocdSolutions.argocdInstance.helm.targetRevision }}
    plugin:
      env:
        - name: HELM_RELEASE_NAME
          value: "argocd-instance"
        - name: HELM_VALUES
          value: |
            argocdInstance:

              nodeSelector: {{ toYaml .Values.components.argocdSolutions.argocdInstance.nodeSelector | nindent 16 }}
              tolerations: {{ toYaml .Values.components.argocdSolutions.argocdInstance.tolerations | nindent 16 }}

              ingressDomain: "{{ .Values.components.argocdSolutions.argocdInstance.ingressDomain }}"

              adminSecurityGroup: {{ .Values.components.argocdSolutions.argocdInstance.adminSecurityGroup }}
              disableAdmin: "{{ .Values.components.argocdSolutions.argocdInstance.disableAdmin }}"
              oidcAuthSP:
                tenantID: "{{ .Values.components.argocdSolutions.argocdInstance.oidcAuthSP.credentials.tenantID }}"
                clientID: "{{ .Values.components.argocdSolutions.argocdInstance.oidcAuthSP.credentials.clientID }}"
                clientSecret: "{{ .Values.components.argocdSolutions.argocdInstance.oidcAuthSP.credentials.clientSecret }}"

              argocdVaultPlugin:
                env: {{ toYaml .Values.components.argocdSolutions.argocdInstance.argocdVaultPlugin.env | nindent 18 }}

                azure:
                  AADPodIdentity:
                    enabled: {{ default "false" .Values.components.argocdSolutions.argocdInstance.argocdVaultPlugin.azure.AADPodIdentity.enabled }}
                    {{- if .Values.components.argocdSolutions.argocdInstance.argocdVaultPlugin.azure.AADPodIdentity.enabled }}
                    managedIdentity:
                      clientID: {{ .Values.components.argocdSolutions.argocdInstance.argocdVaultPlugin.azure.AADPodIdentity.managedIdentity.clientID }}
                      resourceID: {{ .Values.components.argocdSolutions.argocdInstance.argocdVaultPlugin.azure.AADPodIdentity.managedIdentity.resourceID }}
                    {{- end }}

              sourceNamespaces: {{ toYaml .Values.components.argocdSolutions.argocdInstance.sourceNamespaces | nindent 16 }}

              server:
                autoscale:
                  enabled: true
                {{- if .Values.components.argocdSolutions.argocdInstance.server.service }}
                service: {{ toYaml .Values.components.argocdSolutions.argocdInstance.server.service | nindent 18 }}
                {{- end }}
                resources: {{ toYaml .Values.components.argocdSolutions.argocdInstance.server.resources | nindent 18 }}

              repo:
                resources: {{ toYaml .Values.components.argocdSolutions.argocdInstance.repo.resources | nindent 18 }}

              controller:
                resources: {{ toYaml .Values.components.argocdSolutions.argocdInstance.controller.resources | nindent 18 }}

              applicationSet:
                resources: {{ toYaml .Values.components.argocdSolutions.argocdInstance.applicationSet.resources | nindent 18 }}

              redis:
                resources: {{ toYaml .Values.components.argocdSolutions.argocdInstance.redis.resources | nindent 18 }}

              notifications:
                enabled: {{ .Values.components.argocdSolutions.argocdInstance.notifications.enabled }}

            netpol:
              enabled: {{ .Values.components.argocdSolutions.argocdInstance.netpol.enabled }}

            register:
              {{- if .Values.components.argocdSolutions.argocdInstance.register.clusters }}
              clusters: {{  toYaml .Values.components.argocdSolutions.argocdInstance.register.clusters | nindent 16 }}
              {{- end }}

              {{- if .Values.components.argocdSolutions.argocdInstance.register.repositories }}
              repositories: {{  toYaml .Values.components.argocdSolutions.argocdInstance.register.repositories | nindent 16 }}
              {{- end }}

              {{- if .Values.components.argocdSolutions.argocdInstance.register.repositoryCreds }}
              repositoryCreds: {{  toYaml .Values.components.argocdSolutions.argocdInstance.register.repositoryCreds | nindent 16 }}
              {{- end }}

  destination:
    name: '{{ .Values.global.cluster }}'
    namespace: argocd-solutions-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true

{{- end }}