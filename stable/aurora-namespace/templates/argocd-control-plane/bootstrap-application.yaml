apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bootstrap-applications
  namespace: {{ $.Release.Name }}
spec:
  generators:
    - matrix:
        generators:
          # 1. Filter repositories by topic & repository name
          - scmProvider:
              github:
                organization: "{{ .Values.argocd.github.organization }}" 
                tokenRef:
                  secretName: github-creds
                  key: token
              filters:
                - topicMatch: "deploy-repository"
                - repositoryMatch: "^{{ .Values.argocd.github.repositoryName }}$"

          # 2. Only create app if the 'applications' directory exists in that repo
          - git:
              repoURL: "{{ url }}"
              revision: HEAD
              directories:
                - path: applications
  template:
    metadata:
      name: "bootstrap-{{ repository }}"
      namespace: {{ $.Release.Name }}
    spec:
      project: "bootstrap-{{ $.Release.Name }}"
      source:
        repoURL: "{{ url }}"
        targetRevision: HEAD
        path: applications
      destination:
        server: in-cluster
        namespace: {{ $.Release.Name }}
