{{- if eq .Values.namespace.type "solution" }}

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: "solution-{{ $.Release.Name }}-gitops-namespace"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    app.kubernetes.io/name: namespace
    app.kubernetes.io/instance: {{ $.Release.Name }}
spec:
  project: {{ $.Values.global.project }}
  source:
    chart: {{ default "aurora-namespace" $.Values.global.helm.chart }}
    {{- if $.Values.global.helm.repository }}
    repoURL: {{ default $.Values.global.helm.repository $.Values.global.helm.repository }}
    {{- else }}
    repoURL: {{ default "https://gccloudone-aurora.github.io/aurora-platform-charts" $.Values.global.helm.repository }}
    {{- end }}
    targetRevision: {{ default "0.0.1" $.Values.global.helm.targetRevision }}
    helm:
      releaseName: "gitops-{{ $.Release.Name }}"
      values: |
        information: {{ toYaml $.Values.information | nindent 10 }}

        namespace:
          labels: {{ toYaml $.Values.namespace.labels }}
          type: argocd-control-plane

        netpol:
          allowSameNamespace: true

        policies:
          # List of host/path that can be exposed from the namespace.
          allowedHosts: []

          # Boolean which defines if the namespace should have Istio injection.
          istioInjection: false

          # Refer to https://kubernetes.io/docs/concepts/security/pod-security-admission/
          podSecurityAdmission:
            enforce:
              level: {{ .Values.policies.podSecurityAdmission.enforce.level }}
              version: {{ .Values.policies.podSecurityAdmission.enforce.version }}
            audit:
              level: {{ .Values.policies.podSecurityAdmission.audit.level }}
              version: {{ .Values.policies.podSecurityAdmission.enforce.version }}
            warn:
              level: {{ .Values.policies.podSecurityAdmission.warn.level }}
              version: {{ .Values.policies.podSecurityAdmission.enforce.version }}

        rbac: {{ toYaml $.Values.rbac | nindent 10 }}

        resourceQuotas:
          # The maximum number of pods that can be in the namespace.
          pods: 0
          # Quotas related to services and external traffic.
          services:
            # The maximum number of loadbalancers that can be configured.
            loadbalancers: 0
            # The maximum number of NodePorts that can be configured.
            nodeports: 0
          # The upper limit of storage that can be requested across all persistent volumes.
          # Expects a string value of a number with or without units (uses SI units).
          storage: 0

        argocdProject:
          namespace: {{ .Values.argocdProject.namespace }}
          sourceRepos: {{ .Values.argocdProject.sourceRepos }}
          developerGroups: {{ .Values.argocdProject.developerGroups }}  # defaults to rbac.groups if empty
          adminGroups: {{ .Values.argocdProject.adminGroups }}      # defaults to rbac.groups if empty

  destination:
    name: in-cluster
    namespace: "gitops-{{ $.Release.Name }}"
  syncPolicy:
    automated:
      prune: true
      selfHeal: true

{{- end }}
